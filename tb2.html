<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .table-cell-subject {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .attended {
            background-color: #D1FAE5 !important; /* Green-200 */
            color: #065F46; /* Green-800 */
            border-color: #6EE7B7; /* Green-300 */
        }
        .missed {
            background-color: #FEE2E2 !important; /* Red-200 */
            color: #991B1B; /* Red-800 */
            border-color: #FCA5A5; /* Red-300 */
        }
        .not-applicable {
            background-color: #F3F4F6; /* Gray-100 */
        }
        #summary-table th, #summary-table td {
            padding: 0.75rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Monthly Attendance Tracker</h1>
            <p class="text-lg text-gray-600 mt-2">CGC-J | Physics Group CSE GH | Session: 2025-26</p>
        </header>

        <!-- Controls -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 bg-white p-4 rounded-lg shadow-md">
            <div class="flex items-center space-x-4">
                <label for="month-select" class="font-semibold text-gray-700">Month:</label>
                <select id="month-select" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <!-- Options will be populated by JS -->
                </select>
                <label for="year-select" class="font-semibold text-gray-700">Year:</label>
                <select id="year-select" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <button id="reset-button" class="mt-4 sm:mt-0 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Reset Current Month's Data
            </button>
        </div>
        
        <!-- Main Attendance Table -->
        <div class="overflow-x-auto bg-white rounded-lg shadow-lg">
            <table id="attendance-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <!-- Header will be populated by JS -->
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Body will be populated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Summary Section -->
        <div class="mt-10">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">Attendance Summary</h2>
            <div class="overflow-x-auto bg-white rounded-lg shadow-lg p-4">
                <table id="summary-table" class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="font-semibold text-gray-700">Subject</th>
                            <th class="font-semibold text-gray-700">Total Classes</th>
                            <th class="font-semibold text-green-600">Attended</th>
                            <th class="font-semibold text-red-600">Missed</th>
                            <th class="font-semibold text-blue-600">Attendance %</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body" class="divide-y divide-gray-200">
                        <!-- Summary rows will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // This version handles multiple timetables based on effective dates.
        // Data is saved locally in the browser.

        // Timetable effective from 04-08-2025
        const timetableWeek1 = {
            1: ["EGD", "Engg Maths I", "BEE", "Engg Physics", "MMP (Group G)"],
            2: ["BEE", "Engg Maths I", "Engg Physics", "MPD", "EGD"],
            3: ["Physics Lab (Group G)", "Engg Maths I", "BEE", "Engg Physics"],
            4: ["BEE", "Engg Physics", "Physics Lab (Group H)", "Engg Maths I", "MMP (Group H)"],
            5: ["Engg Maths I", "MPD", "Engg Physics", "BEE"],
            6: [], 0: [],
        };

        // Timetable effective from 11-08-2025
        const timetableWeek2 = {
            1: ["EGD", "Engg Maths I", "BEE", "Engg Physics", "ESL", "MMP"],
            2: ["BEE", "Engg Maths I", "Engg Physics", "MPD", "EGD"],
            3: ["Physics Lab (Group G)", "Engg Maths I", "BEE", "Engg Physics", "Value Added Course", "MMP (Group H)"],
            4: ["BEE", "Engg Physics", "Physics Lab (Group H)", "Engg Maths I", "ESL", "Value Added Course"],
            5: ["Engg Maths I", "MPD", "Engg Physics", "BEE"],
            6: [], 0: [],
        };
        
        // Combine all subjects from all timetables for the summary view
        const allSubjects = [...new Set([
            ...Object.values(timetableWeek1).flat(),
            ...Object.values(timetableWeek2).flat()
        ])].sort();

        let currentYear, currentMonth;
        let attendanceData = {};

        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const resetButton = document.getElementById('reset-button');

        // Function to determine which timetable to use based on the date
        function getTimetableForDate(date) {
            const effectiveDateWeek2 = new Date('2025-08-11T00:00:00');
            // Normalize the input date to remove time component for accurate comparison
            const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            if (checkDate < effectiveDateWeek2) {
                return timetableWeek1;
            }
            return timetableWeek2;
        }

        function initializeDate() {
            // Set the initial view to the start of the session
            const effectiveDate = new Date('2025-08-04');
            currentYear = effectiveDate.getFullYear();
            currentMonth = effectiveDate.getMonth();
        }

        function populateDateSelectors() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthSelect.innerHTML = months.map((month, index) => `<option value="${index}" ${index === currentMonth ? 'selected' : ''}>${month}</option>`).join('');

            yearSelect.innerHTML = '';
            for (let year = 2024; year <= 2030; year++) {
                yearSelect.innerHTML += `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`;
            }
        }

        function loadAttendanceData() {
            const key = `attendance_${currentYear}_${currentMonth}`;
            const savedData = localStorage.getItem(key);
            attendanceData = savedData ? JSON.parse(savedData) : {};
        }

        function saveAttendanceData() {
            const key = `attendance_${currentYear}_${currentMonth}`;
            localStorage.setItem(key, JSON.stringify(attendanceData));
        }

        function renderTable() {
            loadAttendanceData();
            const table = document.getElementById('attendance-table');
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Determine the maximum number of classes from all timetables
            const maxClassesWeek1 = Math.max(...Object.values(timetableWeek1).map(d => d.length));
            const maxClassesWeek2 = Math.max(...Object.values(timetableWeek2).map(d => d.length));
            const maxClasses = Math.max(maxClassesWeek1, maxClassesWeek2);

            // Render Header
            let headerHTML = '<tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>';
            for (let i = 1; i <= maxClasses; i++) {
                headerHTML += `<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Class ${i}</th>`;
            }
            headerHTML += '</tr>';
            table.querySelector('thead').innerHTML = headerHTML;

            // Render Body
            let bodyHTML = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayOfWeek = date.getDay();
                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const currentTimetable = getTimetableForDate(date);
                const dayClasses = currentTimetable[dayOfWeek] || [];
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                bodyHTML += `<tr class="${isWeekend ? 'bg-gray-50' : ''}">`;
                bodyHTML += `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${date.toLocaleDateString('en-GB', { weekday: 'short', day: '2-digit' })}</td>`;

                for (let i = 0; i < maxClasses; i++) {
                    const subject = dayClasses[i];
                    if (subject) {
                        const status = attendanceData[dateString]?.[subject] || 'none';
                        let cellClass = '';
                        if (status === 'attended') cellClass = 'attended';
                        if (status === 'missed') cellClass = 'missed';
                        
                        bodyHTML += `<td class="p-2 text-center align-middle table-cell-subject ${cellClass}" data-date="${dateString}" data-subject="${subject}">
                            <div class="font-semibold text-sm">${subject}</div>
                        </td>`;
                    } else {
                        bodyHTML += '<td class="p-2 text-center align-middle not-applicable"></td>';
                    }
                }
                bodyHTML += '</tr>';
            }
            table.querySelector('tbody').innerHTML = bodyHTML;
            updateSummary();
        }

        function handleCellClick(e) {
            const cell = e.target.closest('.table-cell-subject');
            if (!cell) return;

            const { date, subject } = cell.dataset;
            
            if (!attendanceData[date]) {
                attendanceData[date] = {};
            }

            const currentStatus = attendanceData[date][subject];
            let nextStatus = 'attended';
            if (currentStatus === 'attended') {
                nextStatus = 'missed';
            } else if (currentStatus === 'missed') {
                nextStatus = 'none';
            }
            
            if (nextStatus === 'none') {
                delete attendanceData[date][subject];
                if (Object.keys(attendanceData[date]).length === 0) {
                    delete attendanceData[date];
                }
            } else {
                attendanceData[date][subject] = nextStatus;
            }

            saveAttendanceData();
            renderTable(); // Re-render to update UI and summary
        }

        function updateSummary() {
            const summary = allSubjects.reduce((acc, subject) => {
                acc[subject] = { total: 0, attended: 0, missed: 0 };
                return acc;
            }, {});

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayOfWeek = date.getDay();
                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const currentTimetable = getTimetableForDate(date);
                const dayClasses = currentTimetable[dayOfWeek] || [];

                dayClasses.forEach(subject => {
                    summary[subject].total++;
                    const status = attendanceData[dateString]?.[subject];
                    if (status === 'attended') {
                        summary[subject].attended++;
                    } else if (status === 'missed') {
                        summary[subject].missed++;
                    }
                });
            }

            const summaryBody = document.getElementById('summary-body');
            summaryBody.innerHTML = '';
            for (const subject of allSubjects) {
                const data = summary[subject];
                if (data.total === 0) continue;

                const percentage = data.total > 0 ? ((data.attended / data.total) * 100).toFixed(1) : '0.0';
                let percentageClass = 'text-gray-700';
                if (parseFloat(percentage) >= 75) {
                    percentageClass = 'text-green-600 font-bold';
                } else if (data.total > 0) {
                    percentageClass = 'text-red-600 font-bold';
                }

                summaryBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="font-medium text-left px-4">${subject}</td>
                        <td>${data.total}</td>
                        <td class="text-green-600 font-semibold">${data.attended}</td>
                        <td class="text-red-600 font-semibold">${data.missed}</td>
                        <td class="${percentageClass}">${percentage}%</td>
                    </tr>
                `;
            }
        }

        function handleDateChange() {
            currentMonth = parseInt(monthSelect.value);
            currentYear = parseInt(yearSelect.value);
            renderTable();
        }

        function handleReset() {
            if (confirm("Are you sure you want to delete all attendance data for the current month? This cannot be undone.")) {
                const key = `attendance_${currentYear}_${currentMonth}`;
                localStorage.removeItem(key);
                renderTable();
            }
        }

        // Event Listeners
        document.getElementById('attendance-table').addEventListener('click', handleCellClick);
        monthSelect.addEventListener('change', handleDateChange);
        yearSelect.addEventListener('change', handleDateChange);
        resetButton.addEventListener('click', handleReset);

        // Initial Load
        initializeDate();
        populateDateSelectors();
        renderTable();
    </script>
</body>
</html>
